# è„Šæ¤æ¤é«”æª¢æ¸¬å°ˆæ¡ˆ V2 (Spine Vertebra Detection)

## å°ˆæ¡ˆæ¦‚è¿°

åŸºæ–¼æ·±åº¦å­¸ç¿’çš„è„Šæ¤æ¤é«”é ‚é»è‡ªå‹•æª¢æ¸¬ç³»çµ±ï¼Œç”¨æ–¼ï¼š
- è‡ªå‹•è­˜åˆ¥æ¯å€‹æ¤é«”çš„ 4 å€‹è§’é»ï¼ˆå‰ä¸Šã€å¾Œä¸Šã€å¾Œä¸‹ã€å‰ä¸‹ï¼‰
- è‡ªå‹•è¨ˆç®—æ¤é–“ç›¤é«˜åº¦ã€Wedge angle
- æª¢æ¸¬å‰ç·£å£“è¿«æ€§éª¨æŠ˜ï¼ˆanterior wedging compression fractureï¼‰
- æª¢æ¸¬æ¤é«”æ»‘è„«ï¼ˆspondylolisthesis / retrolisthesisï¼‰
- é©—è­‰æ¤é–“ç›¤é«˜åº¦éé€²è¦å¾‹

**ç‹€æ…‹**: âœ… V2.0 Ready
**æœ€å¾Œæ›´æ–°**: 2025-01

---

## ğŸ†• V2.0 æ–°ç‰¹æ€§

### ç°¡åŒ–æ¨™è¨»æ–¹å¼
- **èˆŠæ–¹å¼**: æ¨™è¨»æ¯å€‹æ¤é–“ç›¤çš„çµ‚æ¿ï¼ˆæ¯å±¤ 4 é»ï¼‰
- **æ–°æ–¹å¼**: æ¨™è¨»æ¯å€‹æ¤é«”çš„ 4 å€‹è§’é»ï¼Œç³»çµ±è‡ªå‹•æ¨ç®—æ¤é–“ç›¤è³‡è¨Š

```
æ¤é«” 4 å€‹é ‚é»ï¼š
    å‰ä¸Šè§’ â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â— å¾Œä¸Šè§’     â† ä¸Šçµ‚æ¿
           â”‚             â”‚
           â”‚   æ¤é«”      â”‚
           â”‚             â”‚
    å‰ä¸‹è§’ â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â— å¾Œä¸‹è§’     â† ä¸‹çµ‚æ¿
           â†‘             â†‘
         å‰ç·£          å¾Œç·£
```

### è‡ªå‹•è¨ˆç®—æŒ‡æ¨™
| æŒ‡æ¨™ | è¨ˆç®—æ–¹å¼ |
|------|----------|
| **å£“è¿«æ€§éª¨æŠ˜** | å‰ç·£é«˜åº¦ < å¾Œç·£é«˜åº¦ Ã— 0.75 |
| **æ¤é–“ç›¤é«˜åº¦** | ä¸Šæ¤é«”ä¸‹çµ‚æ¿ vs ä¸‹æ¤é«”ä¸Šçµ‚æ¿çš„è·é›¢ |
| **Wedge Angle** | æ¤é–“ç›¤ä¸Šä¸‹çµ‚æ¿å¤¾è§’ |
| **Spondylolisthesis** | å¾Œç·£é€£ç·šåç§» > 5% |
| **é«˜åº¦éé€²** | L-spine: L4/5æœ€é«˜; C-spine: å‘ä¸‹éå¢ |

---

## å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚
```bash
pip install -r requirements.txt
```

### å·¥ä½œæµç¨‹

#### 1ï¸âƒ£ æ¨™è¨»æ•¸æ“š
æ‰“é–‹ `spinal-annotation-web.html`ï¼š
1. é¸æ“‡è„Šæ¤é¡å‹ï¼ˆL-spine æˆ– C-spineï¼‰
2. è¼‰å…¥æˆ–è²¼ä¸Š X å…‰å½±åƒ
3. ä¾åºæ¨™è¨»æ¯å€‹æ¤é«”çš„ 4 å€‹è§’é»
4. åŒ¯å‡º JSON æª”æ¡ˆ

**æ¨™è¨»é †åº**ï¼š
- L-spine: ç”±ä¸‹åˆ°ä¸Šï¼ˆS1 â†’ L5 â†’ L4 â†’ ...ï¼‰
- C-spine: ç”±ä¸Šåˆ°ä¸‹ï¼ˆC2 â†’ C3 â†’ C4 â†’ ...ï¼‰

#### 2ï¸âƒ£ æº–å‚™è¨“ç·´æ•¸æ“š
```bash
python prepare_endplate_data.py
```

#### 3ï¸âƒ£ è¨“ç·´æ¨¡å‹
```bash
python train_vertebra_model.py
```

#### 4ï¸âƒ£ æ¨ç†é æ¸¬
```bash
python inference.py --model best_vertebra_model.pth --input spine.dcm
```

---

## å°ˆæ¡ˆçµæ§‹

```
Spine/
â”œâ”€â”€ æ ¸å¿ƒè…³æœ¬
â”‚   â”œâ”€â”€ train_vertebra_model.py     # V2 è¨“ç·´è…³æœ¬ (æ¤é«”é ‚é»)
â”‚   â”œâ”€â”€ train_endplate_model.py     # V1 è¨“ç·´è…³æœ¬ (çµ‚æ¿)
â”‚   â”œâ”€â”€ prepare_endplate_data.py    # æ•¸æ“šæº–å‚™ (æ”¯æ´ V1/V2)
â”‚   â”œâ”€â”€ inference.py                # æ¨ç†é æ¸¬
â”‚   â””â”€â”€ api_server.py               # FastAPI æœå‹™
â”‚
â”œâ”€â”€ æ¨™è¨»å·¥å…·
â”‚   â””â”€â”€ spinal-annotation-web.html  # V2 æ¨™è¨»å·¥å…· (æ¤é«”4é ‚é»)
â”‚
â”œâ”€â”€ æ–‡ä»¶
â”‚   â”œâ”€â”€ README.md                   # æœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ USAGE_GUIDE.md              # è©³ç´°ä½¿ç”¨æŒ‡å—
â”‚   â””â”€â”€ TECHNICAL_REFERENCE.md      # æŠ€è¡“åƒè€ƒ
â”‚
â””â”€â”€ è³‡æ–™å¤¾
    â”œâ”€â”€ endplate_training_data/     # è¨“ç·´æ•¸æ“š
    â””â”€â”€ inference_results/          # æ¨ç†çµæœ
```

---

## æ¨¡å‹æ¶æ§‹ V2

```
è¼¸å…¥: [B, 3, 512, 512]
  â†“
ResNet50 Backbone (é è¨“ç·´)
  â†“
é›™åˆ†æ”¯æ¶æ§‹:
â”œâ”€â”€ ç†±åœ–åˆ†æ”¯: ç²—å®šä½è§’é» â†’ [B, 1, 256, 256]
â””â”€â”€ å›æ­¸åˆ†æ”¯: ç²¾ç¢ºåº§æ¨™ â†’ [B, NÃ—4, 2]
  â†“
è¼¸å‡º:
â”œâ”€â”€ heatmap: è§’é»ç†±åœ–
â”œâ”€â”€ coords: è§’é»åº§æ¨™ (æ­£è¦åŒ– 0-1)
â””â”€â”€ count: æ¤é«”æ•¸é‡
```

### æå¤±å‡½æ•¸
```
L_total = Î±Â·L_heatmap + Î²Â·L_coord + Î³Â·L_count
- L_heatmap: BCE Loss (ç†±åœ–)
- L_coord: MSE Loss (åº§æ¨™å›æ­¸)
- L_count: Cross Entropy Loss (æ¤é«”è¨ˆæ•¸)
- Î±=1.0, Î²=2.0, Î³=0.5
```

---

## JSON æ¨™è¨»æ ¼å¼ V2

```json
{
  "version": "2.0",
  "spineType": "L",
  "vertebrae": [
    {
      "name": "L5",
      "points": {
        "anteriorSuperior": {"x": 100, "y": 200},
        "posteriorSuperior": {"x": 300, "y": 210},
        "posteriorInferior": {"x": 310, "y": 350},
        "anteriorInferior": {"x": 110, "y": 340}
      },
      "anteriorHeight": 140,
      "posteriorHeight": 140,
      "anteriorWedgingFracture": false
    }
  ],
  "discs": [
    {
      "level": "L4/L5",
      "metrics": {
        "anteriorHeight": 15,
        "posteriorHeight": 12,
        "middleHeight": 13.5,
        "wedgeAngle": 5.2
      }
    }
  ],
  "abnormalities": {
    "compressionFractures": [],
    "listhesis": [],
    "heightProgressionIssues": []
  }
}
```

---

## è‡¨åºŠè¦å‰‡

### å£“è¿«æ€§éª¨æŠ˜åˆ¤æ–·
```
å‰ç·£é«˜åº¦ < å¾Œç·£é«˜åº¦ Ã— 0.75 â†’ ç–‘ä¼¼å‰ç·£å£“è¿«æ€§éª¨æŠ˜
```

### æ»‘è„«åˆ¤æ–·
```
å¾Œç·£é€£ç·šåç§» > æ¤é«”å¯¬åº¦çš„ 5% â†’ Spondylolisthesis/Retrolisthesis
```

### æ¤é–“ç›¤é«˜åº¦éé€²
- **L-spine**: L4/5 æ‡‰è©²æœ€é«˜ï¼ŒL5/S1 å¯ä»¥ç¨å°
- **C-spine**: æ¤é–“ç›¤é«˜åº¦æ‡‰è©²å‘ä¸‹éå¢

---

## å¸¸è¦‹å•é¡Œ

| å•é¡Œ | è§£æ±ºæ–¹æ¡ˆ |
|------|----------|
| æ‰¾ä¸åˆ°æ¨™è¨»æª”æ¡ˆ | ç¢ºèª JSON æ”¾åœ¨ Spine è³‡æ–™å¤¾ |
| CUDA out of memory | ä¿®æ”¹ batch_size ç‚º 1 |
| æ¨™è¨»å·¥å…·ç„¡æ³•è²¼ä¸Š | ä½¿ç”¨ Ctrl+V æˆ–è¼‰å…¥æª”æ¡ˆ |
| V1 æ ¼å¼ç›¸å®¹æ€§ | ç³»çµ±æœƒè‡ªå‹•è½‰æ›ç‚º V2 æ ¼å¼ |

---

## æ–‡ä»¶èªªæ˜

| æ–‡ä»¶ | å…§å®¹ |
|------|------|
| `README.md` | å¿«é€Ÿå…¥é–€ï¼ˆæœ¬æ–‡ä»¶ï¼‰ |
| `USAGE_GUIDE.md` | è©³ç´°ä½¿ç”¨æŒ‡å—ã€æ¨ç†èªªæ˜ã€å•é¡Œæ’æŸ¥ |
| `TECHNICAL_REFERENCE.md` | æŠ€è¡“ç´°ç¯€ã€å·²è§£æ±ºå•é¡Œã€API åƒè€ƒ |
